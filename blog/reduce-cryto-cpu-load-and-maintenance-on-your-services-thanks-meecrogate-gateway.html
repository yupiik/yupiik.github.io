<!DOCTYPE html>
<html lang="en">

<head>
    <title>Reduce CPU crypto load and deployment maintenance thanks to Meecrogate Gateway</title>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Yupiik Open Source Portal. Discover all Yupiik Open Source Software and Libraries.">
    <meta name="author" content="Yupiik Minisite Generator">
    <meta name="generator" content="Yupiik Minisite Generator">
    
    <link rel="shortcut icon" href="/images/favicon.png">

    <link href="//fonts.googleapis.com/css?family=Open+Sans:300,300i,400,400i,700,700i|Montserrat:300,400,500,700" rel="stylesheet">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css" integrity="sha512-+4zCK9k+qNFUR5X+cKL9EIR+ZOhtIloNl9GIKS57V1MyNsYpYcUrUeQc9vNfzsWfV28IaLL3i96P9sdNyeRssA==" crossorigin="anonymous" />
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/asciidoctor.js/1.5.5-5/css/asciidoctor.min.css" integrity="sha512-kI7tn5cuEg16kMeXnYmg8rEJPxbxzEM7Gsr191iQdLDevFBLXPCSU9aZWSVuP61tMZWU3nBAR1cJ7SmXnOGLZw==" crossorigin="anonymous" />
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.5.3/css/bootstrap.min.css" integrity="sha512-oc9+XSs1H243/FRN9Rw62Fn8EtxjEYWHXRvjS43YtueEewbS6ObfXcJNyohjHqVKFPoXXUxwc+q1K7Dee6vv9g==" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.7.1/styles/atom-one-dark.min.css" integrity="sha512-Fcqyubi5qOvl+yCwSJ+r7lli+CO1eHXMaugsZrnxuU4DVpLYWXTVoHy55+mCb4VZpMgy7PBhV7IiymC0yu9tkQ==" crossorigin="anonymous" />
    <style>
        :root {
            /* YUPIIK colors (from dark to light) */
            --yupiik-site-green: #46F72F;
            --yupiik-site-purple: #D858FF;
            --yupiik-site-blue-light: #02ABEA;
            --yupiik-site-blue-dark: #056EBB;
            --yupiik-site-grey-light: #F4F4F4;
            --yupiik-site-grey-dark: #212121;

            --yupiik-blue1: var(--yupiik-site-blue-dark);
            --yupiik-blue2: var(--yupiik-site-blue-dark);
            --yupiik-blue3: var(--yupiik-site-blue-dark);

            --yupiik-color-white: #fff;
            --yupiik-color-black: #000;

            --yupiik-color-gray-0: var(--yupiik-color-white);
            --yupiik-color-gray-100: #f5f6f7;
            --yupiik-color-gray-200: #ebedf0;
            --yupiik-color-gray-300: #dadde1;
            --yupiik-color-gray-400: #ccd0d5;
            --yupiik-color-gray-500: #bec3c9;
            --yupiik-color-gray-600: #8d949e;
            --yupiik-color-gray-700: #606770;
            --yupiik-color-gray-800: #444950;
            --yupiik-color-gray-900: #1c1e21;
            --yupiik-color-gray-1000: var(--yupiik-color-black);

            --yupiik-color-emphasis-0: var(--yupiik-color-gray-0);
            --yupiik-color-emphasis-100: var(--yupiik-color-gray-100);
            --yupiik-color-emphasis-200: var(--yupiik-color-gray-200);
            --yupiik-color-emphasis-300: var(--yupiik-color-gray-300);
            --yupiik-color-emphasis-400: var(--yupiik-color-gray-400);
            --yupiik-color-emphasis-500: var(--yupiik-color-gray-500);
            --yupiik-color-emphasis-600: var(--yupiik-color-gray-600);
            --yupiik-color-emphasis-700: var(--yupiik-color-gray-700);
            --yupiik-color-emphasis-800: var(--yupiik-color-gray-800);
            --yupiik-color-emphasis-900: var(--yupiik-color-gray-900);
            --yupiik-color-emphasis-1000: var(--yupiik-color-gray-1000);
            --yupiik-color-content: var(--yupiik-color-emphasis-900);

            --yupiik-font-family-base: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, sans-serif, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';
            --yupiik-font-family-monospace: SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;
            --yupiik-font-size-base: 100%;

            --yupiik-font-weight-light: 300;
            --yupiik-font-weight-normal: 400;
            --yupiik-font-weight-semibold: 500;
            --yupiik-font-weight-bold: 700;

            --yupiik-font-weight-base: var(--yupiik-font-weight-normal);
            --yupiik-line-height-base: 1.65;
            --yupiik-font-weight-light: 300;
            --yupiik-font-weight-normal: 400;
            --yupiik-font-weight-semibold: 500;
            --yupiik-font-weight-bold: 700;

            --yupiik-font-weight-base: var(--yupiik-font-weight-normal);
            --yupiik-line-height-base: 1.65;

            --yupiik-global-spacing: 1rem;
            --yupiik-spacing-vertical: var(--yupiik-global-spacing);
            --yupiik-spacing-horizontal: var(--yupiik-global-spacing);

            --yupiik-h1-font-size: 2rem;
            --yupiik-h2-font-size: 1.5rem;
            --yupiik-h3-font-size: 1.25rem;
            --yupiik-h4-font-size: 1rem;
            --yupiik-h5-font-size: 0.875rem;
            --yupiik-h6-font-size: 0.85rem;

            --yupiik-heading-color: var(--yupiik-blue1);
            --yupiik-heading-margin-top: 0;
            --yupiik-heading-margin-bottom: var(--yupiik-spacing-vertical);
            --yupiik-heading-font-family: var(--yupiik-font-family-base);
            --yupiik-heading-font-weight: var(--yupiik-font-weight-bold);
            --yupiik-heading-line-height: 1.25;
        }
    </style>
    <link rel="stylesheet" href="/css/yupiik.github.io.css?v=1.0.0-SNAPSHOT">
            <!-- Matomo -->
            <script>
              var _paq = window._paq = window._paq || [];
              /* tracker methods like "setCustomDimension" should be called before "trackPageView" */
              _paq.push(['trackPageView']);
              _paq.push(['enableLinkTracking']);
              (function() {
              var u="https://yupiik.matomo.cloud/";
              _paq.push(['setTrackerUrl', u+'matomo.php']);
              _paq.push(['setSiteId', '1']);
              var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
              g.async=true; g.src='//cdn.matomo.cloud/yupiik.matomo.cloud/matomo.js'; s.parentNode.insertBefore(g,s);
              })();
            </script>
            <!-- End Matomo Code -->
    <link id="theme-style" rel="stylesheet" href="/css/theme.css?v=1.0.0-SNAPSHOT">
</head>
<body>
    <header class="header fixed-top">
        <div class="branding docs-branding">
            <div class="container-fluid position-relative py-2">
                <div class="docs-logo-wrapper">
	                <div class="site-logo"><a title="Home" class="navbar-brand" href="/index.html">
	                <img class="logo-icon mr-2" src="/images/logo.svg" alt="logo">
	                <span class="logo-text">Open Source <span class="text-alt">Software</span></span></a></div>
                </div>
	            <div class="docs-top-utilities d-flex justify-content-end align-items-center">
					<ul class="header-menu list-inline mx-md-3 mx-lg-5 mb-0 d-none d-lg-flex" >
              <li class="list-inline-item"><a title="Starter" href="/project-starter.html">Starter</a></li>
              <li class="list-inline-item"><a title="Project" href="/projects.html">Project</a></li>
              <li class="list-inline-item"><a title="Community" href="/community.html">Community</a></li>
              <li class="list-inline-item"><a title="Blog" href="/blog/">Blog</a></li>
            </ul>
					<li class="list-inline-item"><a title="Search" id="search-button" href="#" data-toggle="modal" data-target="#searchModal"><i data-toggle="tooltip" data-placement="top" title="Search" class="fas fa-search"></i></a></li>

					<ul class="social-list list-inline mx-md-3 mx-lg-5 mb-0 d-none d-lg-flex">
						<li class="list-inline-item"><a title="Blog" href="/blog/"><i class="fa fa-blog fa-fw"></i></a></li>
						<li class="list-inline-item"><a title="LinkedIn" target="_blank" href="https://www.linkedin.com/company/yupiik/"><i class="fab fa-linkedin fa-fw"></i></a></li>
              <li class="list-inline-item"><a title="Twitter" target="_blank" href="https://twitter.com/Yupiik/"><i class="fab fa-twitter fa-fw"></i></a></li>
              <li class="list-inline-item"><a title="Github" target="_blank" href="https://www.github.com/yupiik"><i class="fab fa-github fa-fw"></i></a></li>
              <li class="list-inline-item"><a title="Sitemap" target="_blank" href="/sitemap.xml"><i class="fas fa-rss-square fa-fw"></i></a></li>
              <li class="list-inline-item"><a title="Yupiik" target="_blank" href="https://www.yupiik.com/"><img class="yupiik-logo" src="/images/yupiik.png"></img></a></li>
		            </ul>
	            </div>
            </div>
        </div>
    </header>
	<div class="page">
        <div id="blog-reduce-cryto-cpu-load-and-maintenance-on-your-services-thanks-meecrogate-gateway-html-container" class="container page-content blog-reduce-cryto-cpu-load-and-maintenance-on-your-services-thanks-meecrogate-gateway-html ">
                        <div class="page-header">
                <h1>Reduce CPU crypto load and deployment maintenance thanks to Meecrogate Gateway</h1>
            </div>
            <div class="page-content-body">
                <div id="preamble">
 <div class="sectionbody">
 <p> <div class="quoteblock abstract">
  <blockquote>
Security is a key aspect in cloud and microservices deployments. However it also has some high impacts like a high CPU consumption due to the cryptographic computation algorithms.  </blockquote>
 </div></p>
 </div>
 </div>
 <div class="sect1" id="_jwt_and_cryptography">
  <h2>JWT and cryptography</h2>
 <div class="sectionbody">
 <div class="paragraph">
 <p>
As a quick reminder, a JSON Web Token (JWT) is composed of three segments:
 </p>
 </div>
 <div class="listingblock">
 <div class="content">
 <pre class="highlightjs highlight"><code class="language-text hljs" data-lang="text">base64Url(jsonHeader).base64Url(jsonPayload).base64Url(signature)</code></pre>
 </div>
 </div>
 <div class="paragraph">
 <p>
Each segment is Base64 URL encoded. The segments composing the JWT are:
 </p>
 </div>
 <ol>
  <li>
 <p>
The JSON header, it contains metadata about the payload and signature (exactly as HTTP headers contain metadata about the HTTP payload - content length, content-type etc...). Generally it is what enables to verify the signature (algorithm, key id), what enables to read the payload (is it compressed or not) etc...,
 </p>
  </li>
  <li>
 <p>
The JSON payload which is an almost free JSON where you can put the data you want to share,
 </p>
  </li>
  <li>
 <p>
The signature which guarantees the token was not modified. It is the signature of the first two segments (concatenated with a separating dot).
 </p>
  </li>
 </ol>
 <div class="paragraph">
 <p>
As you can see, the signature computation is what consumes the most of the CPU since other parts (base64 computation and JSON serialization) are really acceptable/simple.
 </p>
 </div>
 <div class="paragraph">
 <p>
The signature can be of multiple types but the most common are:
 </p>
 </div>
 <div class="ulist">
 <ul>
  <li>
 <p>
RSA (Rivest&ndash;Shamir&ndash;Adleman from the name of their creators),
 </p>
  </li>
  <li>
 <p>
EC (elliptic curve),
 </p>
  </li>
  <li>
 <p>
Hmac (hash based message authentication code),
 </p>
  </li>
  <li>
 <p>
PS (also known as RSASSA-PSS for RSA Probabilistic Signature Scheme).
 </p>
  </li>
 </ul>
 </div>
 <div class="paragraph">
 <p>
Indeed, in the context of this post we only care about the performances but keep in mind you don't always select the algorithm for its performances. A common example is that if you select Hmac, except being exposed to brute force hacking, you can't share the key to verify the JWT since it would enable to create custom JWT which would be valid from a signature point of view. Then in terms of pure performance, depending if you prefer a fast encryption (signing) or decryption (verifying) you will pick RSA or EC depending other security constraints we will not detail in this particular post.
 </p>
 </div>
 </div>
 </div>
 <div class="sect1" id="_microservice_and_jwt_common_usage">
  <h2>Microservice and JWT common usage</h2>
 <div class="sectionbody">
 <div class="paragraph">
 <p>
What we often see in microservice architectures is this kind of deployment:
 </p>
 </div>
 <div class="listingblock">
 <div class="content">
 <pre class="highlightjs highlight"><code class="null hljs">scale max 1024 width

skinparam nodesep 10
skinparam ranksep 10

left to right direction

!define KubernetesPuml https://raw.githubusercontent.com/dcasati/kubernetes-PlantUML/master/dist
!define AzurePuml https://raw.githubusercontent.com/RicardoNiepel/Azure-PlantUML/release/2-1/dist
!define CloudInsight https://raw.githubusercontent.com/plantuml/plantuml-stdlib/master/cloudinsight

!includeurl KubernetesPuml/kubernetes_Common.puml
!includeurl KubernetesPuml/kubernetes_Context.puml
!includeurl KubernetesPuml/kubernetes_Simplified.puml
!includeurl KubernetesPuml/OSS/KubernetesSvc.puml
!includeurl KubernetesPuml/OSS/KubernetesPod.puml
!includeurl AzurePuml/AzureCommon.puml
!includeurl AzurePuml/Databases/AzureSqlDatabase.puml
!includeurl CloudInsight/mysql.puml


Cluster_Boundary(cluster, &quot;Kubernetes Cluster&quot;) {
  Namespace_Boundary(ns, &quot;my-app&quot;) {
    KubernetesSvc(svc, &quot;Service&quot;, &quot;&quot;)
    KubernetesPod(gateway, &quot;Gateway&quot;, &quot;&quot;)
    KubernetesPod(pod1, &quot;API1&quot;, &quot;&quot;)
    KubernetesPod(pod2, &quot;Frontend1&quot;, &quot;&quot;)
    KubernetesPod(pod3, &quot;Backend&quot;, &quot;&quot;)
    database &quot;&lt;$mysql&gt;&quot; as sql #white
  }
}

Rel(svc,gateway,&quot;GET /service* -H 'Authorization:Bearer xxx'&quot;)
Rel(gateway,pod1,&quot;GET /service1 -H 'Authorization:Bearer xxx'&quot;)
Rel(gateway,pod2,&quot;GET /service2 -H 'Authorization:Bearer xxx'&quot;)
Rel(pod2,pod3,&quot;GET /service3 -H 'Authorization:Bearer xxx'&quot;)
Rel(pod3,sql,&quot;SELECT *&quot;)</code></pre>
 </div>
 </div>
 <div class="paragraph">
 <p>
What is interesting to see is that for a quite common application with an API layer, a frontend and a backend service (in real deployments we often have N backend services and not a single one), we propagate the JWT at least 4 times.
 </p>
 </div>
 <div class="admonitionblock note">
  <table>
    <tbody>
     <tr>
      <td class="icon">
     <div class="title">NOTE</div>
       </td>
      <td class="content">
in real applications the JWT is also propagated to topics/Kafka messages to be able to load the security context which makes it even worse.    </td>
   </tr>
      </tbody>
  </table>
 </div>
 <div class="paragraph">
 <p>
Propagating the JWT is not really crazy since it is mainly propagating a header but before using a JWT you must ensure it is valid otherwise you can not trust its content so each service in this chain will have to:
 </p>
 </div>
 <ol>
  <li>
 <p>
Ensure there is a JWT (cheap),
 </p>
  </li>
  <li>
 <p>
Ensure the JWT is valid (cheap, mainly base64 and JSON validation on the header),
 </p>
  </li>
  <li>
 <p>
Ensure the JWT signature is valid (expensive in terms of CPU),
 </p>
  </li>
  <li>
 <p>
Ensure the JWT payload/content is valid (not expired, correct issuer etc...),
 </p>
  </li>
  <li>
 <div class="paragraph">
 <p>Use the JWT (read <code>/groups</code> from the claims/payload for example).</p>
 </div>
  </li>
 </ol>
 <div class="paragraph">
 <p>
This list immediately shows two really impacting points:
 </p>
 </div>
 <div class="ulist">
 <ul>
  <li>
 <p>
On the overall cluster we will pay the token validation again and again on each service (instead of paying 1 we will pay 4 in the simplified example we had before),
 </p>
  </li>
  <li>
 <p>
Each service must have access to the validation data (valid issuer, signature key/certificate, time window validation - there is often some tolerance for expiry case).
 </p>
  </li>
 </ul>
 </div>
 <div class="paragraph">
 <p>
The first point implies a high cloud/machine cost and the last one a high cost in terms of maintenance/deployment/ops.
 </p>
 </div>
 </div>
 </div>
 <div class="sect1" id="_reduce_cpu_and_maintenance_cost_for_jwt_based_applications">
  <h2>Reduce CPU and maintenance cost for JWT based applications</h2>
 <div class="sectionbody">
 <div class="paragraph">
 <p>The simplest solution to solve this cost is to ensure it is paid only once. This is done adding/relying on the gateway in front of <b>all</b> services:</p>
 </div>
 <div class="listingblock">
 <div class="content">
 <pre class="highlightjs highlight"><code class="null hljs">scale max 1024 width

skinparam nodesep 10
skinparam ranksep 10

left to right direction

!define KubernetesPuml https://raw.githubusercontent.com/dcasati/kubernetes-PlantUML/master/dist
!define AzurePuml https://raw.githubusercontent.com/RicardoNiepel/Azure-PlantUML/release/2-1/dist
!define CloudInsight https://raw.githubusercontent.com/plantuml/plantuml-stdlib/master/cloudinsight

!includeurl KubernetesPuml/kubernetes_Common.puml
!includeurl KubernetesPuml/kubernetes_Context.puml
!includeurl KubernetesPuml/kubernetes_Simplified.puml
!includeurl KubernetesPuml/OSS/KubernetesSvc.puml
!includeurl KubernetesPuml/OSS/KubernetesPod.puml
!includeurl AzurePuml/AzureCommon.puml
!includeurl AzurePuml/Databases/AzureSqlDatabase.puml
!includeurl CloudInsight/mysql.puml


Cluster_Boundary(cluster, &quot;Kubernetes Cluster&quot;) {
  Namespace_Boundary(ns, &quot;my-app&quot;) {
    KubernetesSvc(svc, &quot;Service&quot;, &quot;&quot;)
    KubernetesPod(gateway, &quot;Gateway&quot;, &quot;&quot;)
    KubernetesPod(pod1, &quot;API1&quot;, &quot;&quot;)
    KubernetesPod(pod2, &quot;Frontend1&quot;, &quot;&quot;)
    KubernetesPod(pod3, &quot;Backend&quot;, &quot;&quot;)
  }
}

Rel(svc,gateway,&quot;GET /service* -H 'Authorization:Bearer xxx'&quot;)
Rel(gateway,pod1,&quot;GET /service1&quot;)
Rel(gateway,pod2,&quot;GET /service2&quot;)
Rel(pod2,pod3,&quot;GET /service3&quot;)</code></pre>
 </div>
 </div>
 <div class="paragraph">
 <p>
With this new architecture, we only validate read the JWT once....but we loose the JWT claims - which is the only interesting part functionally. For some applications it will be ok-ish (for applications only requiring to be logged in) but generally it will not. This is where the gateway will add a real value because its roles now become:
 </p>
 </div>
 <div class="ulist">
 <ul>
  <li>
 <p>
to validate the JWT and ensure the call is valid,
 </p>
  </li>
  <li>
 <p>
to explode the JWT payload and propagate needed informations through headers.
 </p>
  </li>
 </ul>
 </div>
 <div class="paragraph">
 <p>
Once this second step is done, the calls now look like:
 </p>
 </div>
 <div class="listingblock">
 <div class="content">
 <pre class="highlightjs highlight"><code class="null hljs">scale max 1024 width

skinparam nodesep 10
skinparam ranksep 10

left to right direction

!define KubernetesPuml https://raw.githubusercontent.com/dcasati/kubernetes-PlantUML/master/dist
!define AzurePuml https://raw.githubusercontent.com/RicardoNiepel/Azure-PlantUML/release/2-1/dist
!define CloudInsight https://raw.githubusercontent.com/plantuml/plantuml-stdlib/master/cloudinsight

!includeurl KubernetesPuml/kubernetes_Common.puml
!includeurl KubernetesPuml/kubernetes_Context.puml
!includeurl KubernetesPuml/kubernetes_Simplified.puml
!includeurl KubernetesPuml/OSS/KubernetesSvc.puml
!includeurl KubernetesPuml/OSS/KubernetesPod.puml
!includeurl AzurePuml/AzureCommon.puml
!includeurl AzurePuml/Databases/AzureSqlDatabase.puml
!includeurl CloudInsight/mysql.puml


Cluster_Boundary(cluster, &quot;Kubernetes Cluster&quot;) {
  Namespace_Boundary(ns, &quot;my-app&quot;) {
    KubernetesSvc(svc, &quot;Service&quot;, &quot;&quot;)
    KubernetesPod(gateway, &quot;Gateway&quot;, &quot;&quot;)
    KubernetesPod(pod1, &quot;API1&quot;, &quot;&quot;)
    KubernetesPod(pod2, &quot;Frontend1&quot;, &quot;&quot;)
    KubernetesPod(pod3, &quot;Backend&quot;, &quot;&quot;)
  }
}

Rel(svc,gateway,&quot;GET /service* -H 'Authorization:Bearer xxx'&quot;)
Rel(gateway,pod1,&quot;GET /service1 -H 'JWT-sub:user1' -H 'JWT-groups:admin,manager'&quot;)
Rel(gateway,pod2,&quot;GET /service2 -H 'JWT-groups:admin,manager'&quot;)
Rel(pod2,pod3,&quot;GET /service3 -H 'JWT-groups:admin,manager'&quot;)</code></pre>
 </div>
 </div>
 <div class="paragraph">
 <p>With such solution, the important JWT information - here the <code>sub</code> which is the username/login and <code>groups</code> which contains the list of roles - are propagated through dedicated headers to services.</p>
 </div>
 <div class="admonitionblock tip">
  <table>
    <tbody>
     <tr>
      <td class="icon">
     <div class="title">TIP</div>
       </td>
      <td class="content">
 <div class="paragraph">
 <p>the <code>JWT-</code> prefix is a convention but you can use any header name, just ensure to normalize it in the company to enable a service to transparently forward them if needed by filtering them on the prefix.</p>
 </div>
    </td>
   </tr>
      </tbody>
  </table>
 </div>
 <div class="paragraph">
 <p>
The last step you can go through is to validate the role on the gateway when possible but often it will be linked to some business rules so will need to be done in the service.
 </p>
 </div>
 </div>
 </div>
 <div class="sect1" id="_meecrogate_example">
  <h2>Meecrogate example</h2>
 <div class="sectionbody">
 <div class="paragraph">
 <p>
Meecrogate gateway enables to implement this pattern by configuration. Using the JSON configuration - but it works exactly the same with the environment variables configuration, the route will be composed of 4 sections:
 </p>
 </div>
 <ol>
  <li>
 <p>
The matcher section which specifies how to select this route configuration for an incoming request,
 </p>
  </li>
  <li>
 <p>
The proxy section which specifies where to forward the request once validated/prepared,
 </p>
  </li>
  <li>
 <p>
The shield section which specifies how to validate the request before starting to prepare it and forwarding it,
 </p>
  </li>
  <li>
 <p>
The enricher section which enables to modify the incoming request before forwarding it to another service.
 </p>
  </li>
 </ol>
 <div class="paragraph">
 <p>
Assuming we are defining the route for the service 1 of previous diagram, the matcher section can look like:
 </p>
 </div>
 <div class="listingblock">
 <div class="content">
 <pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{
  &quot;shortName&quot;: &quot;JWT validation+explosion&quot;,
  &quot;matcherConfiguration&quot;: {
    &quot;matcherType&quot;: &quot;STARTS_WITH&quot;,
    &quot;matcherValue&quot;: &quot;/service1&quot;
  },
  ...
}</code></pre>
 </div>
 </div>
 <div class="paragraph">
 <p>
Similarly, the proxy section will just target the service1 host:
 </p>
 </div>
 <div class="listingblock">
 <div class="content">
 <pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{
  ...,
  &quot;mode&quot;: &quot;PROXY&quot;,
  &quot;proxyConfiguration&quot;: {
    &quot;proxyScheme&quot;: &quot;https&quot;,
    &quot;authorities&quot;: [ &quot;service1.company.com&quot; ]
  },
  ...
}</code></pre>
 </div>
 </div>
 <div class="paragraph">
 <p>
Now the core of the security (the shield layer) will validate our incoming JWT:
 </p>
 </div>
 <div class="listingblock">
 <div class="content">
 <pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{
  ...,
  &quot;shieldConfiguration&quot;: [{ <b class="conum">(1)</b>
    &quot;jwt&quot;: {
      &quot;typValidation&quot;: [{ <b class="conum">(2)</b>
        &quot;expected&quot;: &quot;JWT&quot;,
        &quot;required&quot;: true
      }],
      &quot;expiryValidation&quot;: [{ <b class="conum">(3)</b>
        &quot;expiryRequired&quot;: true,
        &quot;issuedAtRequired&quot;: true
      }],
      &quot;claimValidations&quot;: [ <b class="conum">(4)</b>
        { &quot;claimKey&quot;: &quot;sub&quot; },
        { &quot;claimKey&quot;: &quot;groups&quot; }
      ],
      &quot;issuerValidation&quot;: [{ <b class="conum">(5)</b>
          &quot;expected&quot;: &quot;https://app.company.com/oauth2/&quot;
      }],
      &quot;signatureValidation&quot;: [{ <b class="conum">(6)</b>
        &quot;alg&quot;: &quot;RS256&quot;,
        &quot;kid&quot;: &quot;app-key&quot;,
        &quot;key&quot;: &quot;xxxxxxx&quot;
      }],
    }
  }],
  ...
}</code></pre>
 </div>
 </div>
 <div class="colist arabic">
  <ol>
   <li>
 <span>
We add a shield configuration which is basically our JWT validation,
 </span>
   </li>
   <li>
 <span>
We validate our JWT 
 </span>
<code>typ</code> <span>
 value,
 </span>
   </li>
   <li>
 <span>
We validate our validity window (expiry and issued at values),
 </span>
   </li>
   <li>
 <span>
We validate the presence of the needed claims (
 </span>
<code>sub</code> <span>
 and 
 </span>
<code>groups</code> <span>
 there) - note that this block can also validate the actual value and not only the presence,
 </span>
   </li>
   <li>
 <span>
We validate the JWT was issued for the application we proxy - here again, if the application/service tolerates multiple issuers we can have multiple routes,
 </span>
   </li>
   <li>
 <span>
We validate the JWT signature to guarantee we can trust it giving the key to use to,
 </span>
   </li>
  </ol>
 </div>
 <div class="paragraph">
 <p>
Now our JWT is validated, we can modify the incoming request to forward the needed information to the actual service:
 </p>
 </div>
 <div class="listingblock">
 <div class="content">
 <pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{
  ...,
  &quot;enricherConfiguration&quot;: {
    &quot;requestAdditionalHeaders&quot;: [ <b class="conum">(1)</b>
      { <b class="conum">(2)</b>
        &quot;action&quot;: &quot;SET&quot;,
        &quot;name&quot;: &quot;JWT-sub&quot;,
        &quot;value&quot;: &quot;${request:jwt:claim:sub}&quot;
      },
      { <b class="conum">(2)</b>
        &quot;action&quot;: &quot;SET&quot;,
        &quot;name&quot;: &quot;JWT-groups&quot;,
        &quot;value&quot;: &quot;${request:jwt:claim:groups?csv=,}&quot;
      },
      { <b class="conum">(3)</b>
        &quot;action&quot;: &quot;REMOVE&quot;,
        &quot;name&quot;: &quot;Authorization&quot;
      }
    ]
  }
}</code></pre>
 </div>
 </div>
 <div class="colist arabic">
  <ol>
   <li>
 <span>
We add now the configuration to mutate the incoming request headers to the proxied request headers,
 </span>
   </li>
   <li>
 <span>
We add our two 
 </span>
<code>JWT-x</code> <span>
 headers propagating the value from the JWT claims using 
 </span>
<code>request:jwt:claim:x</code> <span>
 interpolation mecanism - enabling to apply this pattern to any custom claims keys and values too. The 
 </span>
<code>csv=,</code> <span>
 option added to groups enables to convert the array of string to a CSV string enabling a simpler consumption by downstream services,
 </span>
   </li>
   <li>
 <span>
We drop the original 
 </span>
<code>Authorization</code> <span>
 header which is no more needed in the subsystem.
 </span>
   </li>
  </ol>
 </div>
 </div>
 </div>
 <div class="sect1" id="_impact_of_forwarding_data_into_headers_on_services">
  <h2>Impact of forwarding data into headers on services</h2>
 <div class="sectionbody">
 <div class="paragraph">
 <p>
If you migrate from a JWT parsing solution (microprofile-jwt-auth, spring-boot-starter-security, etc...) to this header based solution you will still need to load the security context but you can now trust the incoming headers since the JWT was validated properly and information are properly forwarded.
 </p>
 </div>
 <div class="paragraph">
 <p>
In terms of (pseudo-)code, it means moving from this kind of implementation:
 </p>
 </div>
 <div class="listingblock">
 <div class="content">
 <pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">final var token = readJwtTokenFromHeader(request);
validateJwt(token);
final var jwt = extractJwtPayload(token);
//...
final var groups = jwt.getClaim(&quot;groups&quot;);
if (!isAllowed(groups)) {
    throw new WebApplicationException(...);
}</code></pre>
 </div>
 </div>
 <div class="paragraph">
 <p>
to
 </p>
 </div>
 <div class="listingblock">
 <div class="content">
 <pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">final var ctx = extractUserContext(request);
//...
final var groups = ctx.getClaim(&quot;groups&quot;);
if (!isAllowed(groups)) {
    throw new WebApplicationException(...);
}</code></pre>
 </div>
 </div>
 <div class="paragraph">
 <p>
The interesting part is that the change is mainly about the part before the comment line. This means that once integrated with your security framework (from a simple interceptor to the full security framework like Apache Shiro or the widely spread Spring security), it does not change your application much.
 </p>
 </div>
 <div class="admonitionblock tip">
  <table>
    <tbody>
     <tr>
      <td class="icon">
     <div class="title">TIP</div>
       </td>
      <td class="content">
this is one of the reason to take time to properly setup your application stack and not take the shortcut to code transversal concerns like security ones in the business layer.    </td>
   </tr>
      </tbody>
  </table>
 </div>
 <div class="paragraph">
 <p>
Now the JWT extracton is not that complex to implement, in particular since the JVM or most common languages contain all the needed bricks, but its validation can be tricky and if you do an error there, there is no more security in the system. On another side, the user context loading is only about reading headers and optionally parsing a json value for most complex cases so it is very very doable by any framework and developer.
 </p>
 </div>
 <div class="paragraph">
 <p>To illustrate that I will just show what <code>extractUserContext</code> can look like in a JAX-RS based application in two steps:</p>
 </div>
 <ol>
  <li>
 <p>
Define the UserContext model,
 </p>
  </li>
  <li>
 <p>
Inject the user context instance in your endpoints.
 </p>
  </li>
 </ol>
 <div class="paragraph">
 <p>
Here is how tp define the user context we spoke about ealier:
 </p>
 </div>
 <div class="listingblock">
 <div class="content">
 <pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Data
public class UserContext {
   @HeaderParam(&quot;JWT-sub&quot;)
   private String sub;

   @HeaderParam(&quot;JWT-groups&quot;)
   private List&lt;String&gt; groups;
}</code></pre>
 </div>
 </div>
 <div class="paragraph">
 <p>
Once we have an user context we can simply inject it into any endpoint:
 </p>
 </div>
 <div class="listingblock">
 <div class="content">
 <pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@RequestScoped
@Path(&quot;api&quot;)
public class MyResource {
    @GET
    public MyData get(@BeanParam final UserContext ctx) {
        if (!ctx.hasRole(&quot;admin&quot;)) {
            throw new WebApplicationException(Response.Status.FORBIDDEN);
        }
        return fetchData();
    }
}</code></pre>
 </div>
 </div>
 <div class="admonitionblock tip">
  <table>
    <tbody>
     <tr>
      <td class="icon">
     <div class="title">TIP</div>
       </td>
      <td class="content">
 <div class="paragraph">
 <p>making <code>UserContext</code> hosting some security helper method makes it generally easier to use.</p>
 </div>
    </td>
   </tr>
      </tbody>
  </table>
 </div>
 </div>
 </div>
 <div class="sect1" id="_use_a_gateway_dont_do_it_in_a_service">
  <h2>Use a gateway, don't do it in a service</h2>
 <div class="sectionbody">
 <div class="paragraph">
 <p>
It is natural to think that any service can play that gateway role and that you can keep microprofile-jwt-auth, spring-security etc to do that gateway role. Technically it is true but the key point here is the architecture: the service should be central (which does not mean a SPoF, previous Meecrogate example has no SPoF since it scales properly horizontally for example). Using a service, the risk - which is quite high - is to start adding other services bypassing it and being back to the original issue so the rule of thumb there is to use a gateway. Techically you can use whatever you want from a plain HTTPd/NGINX/Tomcat with custom glue code to a real gateway like Meecrogate one but ensuring the instances act as gateways is what will make this solution robust in time.
 </p>
 </div>
 <div class="paragraph">
 <p>
Another good reason to make some instances acting as a gateway is to enable them to use a cache. Once some instances are the &quot;gateway&quot;, you can optimize them to have the relevant CPU and memory profile making your security layer very cheap for end user in terms of experience which is key to offer a good service.
 </p>
 </div>
 <div class="paragraph">
 <p>
Depending the size of your company you can also be concerned about security audits, and in such a case, having a gateway enables to justify only once about the security concerns whereas doing it in all services will require to provide such guarantees in all services which can be a lot of efforts and as much errors you can encounter.
 </p>
 </div>
 <div class="paragraph">
 <p>
Last point is that once you passed the gateway, everything is &quot;user context&quot; which means it will integrate smoothly with messaging system needing the user context and will not require Kafka topics to be replayed overloading the authentication system for example (using CQRS pattern it happens very easily when global architecture was not thought upfront).
 </p>
 </div>
 </div>
 </div>
 <div class="sect1" id="_conclusion">
  <h2>Conclusion</h2>
 <div class="sectionbody">
 <div class="paragraph">
 <p>
We saw in this post that:
 </p>
 </div>
 <div class="ulist">
 <ul>
  <li>
 <p>
cloud and microservice deployments require some understanding of the overall system and not just of each piece compsing it alone,
 </p>
  </li>
  <li>
 <p>
using JWT token enables stateless deployments without having to imply an outstanding CPU/resource consumption,
 </p>
  </li>
  <li>
 <p>
using a gateway enables to focus on the business in services,
 </p>
  </li>
  <li>
 <p>
using a gateway enables concentrate the security effort and user context modelling in a single location,
 </p>
  </li>
  <li>
 <p>
using a gateway enables to optimize resource consumption,
 </p>
  </li>
  <li>
 <p>
using a gateway enables to have better guarantees about the security and simplify the audits.
 </p>
  </li>
 </ul>
 </div>
 <div class="paragraph">
 <p>
So the conclusion of this post is: always think your system widely and not per service and if relevant use a real gateway!
 </p>
 </div>
 </div>
 </div>
                
                
            </div>
        </div>
    <div class="page-navigation-right">
        <h3>Navigation</h3>
        <nav class="generated-nav-menu"></nav>
    </div>
    </div>
    <footer class="footer pb-5">
	    <div class="text-center">
		    <ul class="social-list list-unstyled">
                <li class="list-inline-item"><a title="LinkedIn" target="_blank" href="https://www.linkedin.com/company/yupiik/"><i class="fab fa-linkedin fa-fw"></i></a></li>
              <li class="list-inline-item"><a title="Twitter" target="_blank" href="https://twitter.com/Yupiik/"><i class="fab fa-twitter fa-fw"></i></a></li>
              <li class="list-inline-item"><a title="Github" target="_blank" href="https://www.github.com/yupiik"><i class="fab fa-github fa-fw"></i></a></li>
              <li class="list-inline-item"><a title="Sitemap" target="_blank" href="/sitemap.xml"><i class="fas fa-rss-square fa-fw"></i></a></li>
              <li class="list-inline-item"><a title="Yupiik" target="_blank" href="https://www.yupiik.com/"><img class="yupiik-logo" src="/images/yupiik.png"></img></a></li>
	        </ul>
            <small class="copyright">© 2024 <strong>Yupiik</strong>. All Rights Reserved</small> | <a href="https://www.yupiik.com/terms-of-use/">Terms of use</a> | <a href="https://www.yupiik.com/privacy-policy/">Privacy policy</a>
	    </div>
    </footer>

    <div class="modal fade" id="searchModal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="searchModalLabel">Search</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <form onsubmit="return false;" class="form-inline">
          <div class="form-group">
            <label for="searchInput"><b>Search: </b></label>
            <input class="form-control" id="searchInput" placeholder="Enter search text and hit enter...">
          </div>
        </form>
        <div class="search-hits"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" ></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.5.3/js/bootstrap.min.js" integrity="sha512-8qmis31OQi6hIRgvkht0s6mCOittjMa9GMqtK9hes5iEQBQE/Ca6yGE5FsW36vyipGoWQswBj/QBm2JR086Rkw==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.7.1/highlight.min.js" integrity="sha512-d00ajEME7cZhepRqSIVsQVGDJBdZlfHyQLNC6tZXYKTG7iwcF8nhlFuppanz8hYgXr8VvlfKh4gLC25ud3c90A==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.7.1/languages/bash.min.js" integrity="sha512-Hg0ufGEvn0AuzKMU0psJ1iH238iUN6THh7EI0CfA0n1sd3yu6PYet4SaDMpgzN9L1yQHxfB3yc5ezw3PwolIfA==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.7.1/languages/bash.min.js" integrity="sha512-Hg0ufGEvn0AuzKMU0psJ1iH238iUN6THh7EI0CfA0n1sd3yu6PYet4SaDMpgzN9L1yQHxfB3yc5ezw3PwolIfA==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.7.1/languages/json.min.js" integrity="sha512-37sW1XqaJmseHAGNg4N4Y01u6g2do6LZL8tsziiL5CMXGy04Th65OXROw2jeDeXLo5+4Fsx7pmhEJJw77htBFg==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.7.1/languages/dockerfile.min.js" integrity="sha512-eRNl3ty7GOJPBN53nxLgtSSj2rkYj5/W0Vg0MFQBw8xAoILeT6byOogENHHCRRvHil4pKQ/HbgeJ5DOwQK3SJA==" crossorigin="anonymous"></script>
    <script>if (!(window.minisite || {}).skipHighlightJs) { hljs.highlightAll();
function addCopyButtons(clipboard) {
  document.querySelectorAll('pre > code').forEach(function (codeBlock) {
  var button = document.createElement('button');  button.className = 'copy-code-button';  button.type = 'button';  button.innerText = 'Copy';  button.addEventListener('click', function () {   clipboard.writeText(codeBlock.innerText).then(function () {   button.blur();   button.innerText = 'Copied!';   setTimeout(function () { button.innerText = 'Copy'; }, 2000); }, function (error) { button.innerText = 'Error'; });  });  var pre = codeBlock.parentNode;  if (pre.parentNode.classList.contains('highlight')) {   var highlight = pre.parentNode; highlight.parentNode.insertBefore(button, highlight);  } else { pre.parentNode.insertBefore(button, pre); } });}
if (navigator && navigator.clipboard) { addCopyButtons(navigator.clipboard);} else { var script = document.createElement('script'); script.src = '//cdnjs.cloudflare.com/ajax/libs/clipboard-polyfill/2.7.0/clipboard-polyfill.promise.js'; script.integrity = 'sha256-waClS2re9NUbXRsryKoof+F9qc1gjjIhc2eT7ZbIv94='; script.crossOrigin = 'anonymous'; script.onload = function() {addCopyButtons(clipboard);}; document.body.appendChild(script);} }</script>
    <script src="/js/minisite.js?v=1.0.0-SNAPSHOT"></script>
    <script>$('.page-content-body').generatedNavMenu();</script>
    <script>$('.is-blog').addClass('container');</script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.3/fuse.min.js" integrity="sha512-neoBxVNv0UMXjoilAYGxfWrSsW6iAVclx7vQKdPJ9Peet1bM5YQjU0aIB8LtH8iNPa+pAyMZprBBw2ZQ/Q1LjQ==" crossorigin="anonymous"></script>

</body>
</html>